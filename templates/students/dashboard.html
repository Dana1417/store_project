{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة الطالب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f9f9f9; --fg:#333; --muted:#666; --card:#fff;
      --border:#e0e0e0; --shadow:0 6px 16px rgba(0,0,0,.06);
      --brand:#1976d2; --warn:#ff6f00; --kpi-bg:#fffaf2; --kpi-br:#ffe0b2;
    }
    body { font-family: "Tajawal", system-ui, -apple-system, Arial, sans-serif; margin:0; padding:0; background:var(--bg); color:var(--fg); }
    .page-padding { padding-top: 90px; }
    .dashboard-container { max-width: 960px; margin: 0 auto 60px; padding: 24px; background:var(--card); border-radius:16px; box-shadow:var(--shadow); }

    .headline { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
    h1 { color:#2c3e50; font-size:26px; margin:0; }
    .actions a { text-decoration:none; padding:8px 14px; border-radius:10px; font-weight:600; }
    .actions a.logout { background:#fbe9e7; color:#d32f2f; }

    .messages { margin-bottom:14px; }
    .msg { padding:10px 12px; border-radius:10px; margin:8px 0; border:1px solid; }
    .msg.success { background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .msg.warning { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
    .msg.error { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
    .msg.info { background:#eff6ff; color:#1e40af; border-color:#bfdbfe; }

    .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin:18px 0 24px; }
    .kpi { background:var(--kpi-bg); border:1px solid var(--kpi-br); border-radius:12px; padding:14px; text-align:center; }
    .kpi b { color:var(--warn); font-size:14px; display:block; margin-bottom:6px; }
    .kpi .num { font-size:22px; font-weight:800; color:#2c3e50; }

    .section-title { margin:18px 0 10px; font-size:20px; font-weight:700; color:#333; }
    .muted { color:var(--muted); font-size:14px; }
    .empty { padding:16px; border:1px dashed #ccc; border-radius:12px; background:#fff; color:#777; text-align:center; }

    .course-card { border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:12px; background:#fdfdfd; }
    .course-card__head { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .course-title { margin:0; font-size:18px; color:var(--brand); font-weight:700; }
    .course-meta { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .cover { width:56px; height:56px; border-radius:10px; object-fit:cover; border:1px solid var(--border); background:#fff; }

    .btn { text-decoration:none; padding:8px 12px; border-radius:10px; font-weight:600; border:1px solid #cfd8dc; background:#fff; color:#37474f; }
    .btn:hover { background:#f5f5f5; }
    .btn-primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn-primary:hover { filter:brightness(0.95); }

    .list-cards { list-style:none; padding:0; margin:0; }
    .list-card { display:flex; align-items:center; justify-content:space-between; gap:12px; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:12px; background:#fff; }

    @media (max-width: 768px) {
      .dashboard-container{padding:18px;}
      h1{font-size:22px;}
      .course-card__head{flex-direction:column; align-items:flex-start;}
      .list-card{flex-direction:column; align-items:flex-start;}
    }
  </style>
</head>
<body>

  {% include "header.html" %}

  <main class="page-padding">
    <section class="dashboard-container" aria-labelledby="student-dashboard-title">

      <div class="headline">
        <h1 id="student-dashboard-title">مرحبًا، {{ student.user.get_full_name|default:student.user.username }}</h1>
        <div class="actions">
          <a class="logout" href="/logout/">تسجيل خروج</a>
        </div>
      </div>

      {% if messages %}
        <div class="messages" role="status" aria-live="polite">
          {% for message in messages %}
            <div class="msg {{ message.tags|default:'info' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="kpis" aria-label="إحصائيات سريعة">
        <div class="kpi"><b>الدورات المسجّلة</b><div class="num">{{ enroll_count }}</div></div>
        <div class="kpi"><b>نتائج الاختبارات</b><div class="num">{{ exam_count }}</div></div>
        <div class="kpi"><b>الشهادات</b><div class="num">{{ cert_count }}</div></div>
        <div class="kpi"><b>المراجع المتاحة</b><div class="num">{{ res_count }}</div></div>
      </div>

      <!-- ===== الدورات المسجّلة (النشطة/المدفوعة) ===== -->
      <h3 class="section-title">الدورات المسجّلة</h3>
      {% if enrollments %}
        {% for e in enrollments %}
          <article class="course-card">
            <div class="course-card__head">

              <div class="course-meta">
                {% if e.course.cover_image_url %}
                  <img class="cover" src="{{ e.course.cover_image_url }}" alt="غلاف {{ e.course.title }}">
                {% endif %}

                <!-- عنوان الدورة يفتح صفحة التفاصيل (بالـ pk) -->
                <h4 class="course-title">
                  📘
                  <a href="{% url 'students:course_detail_by_id' e.course.pk %}"
                     class="course-title" style="text-decoration:none; color:var(--brand)">
                    {{ e.course }}
                  </a>
                </h4>
              </div>

              <!-- زر الدخول للحصة (Teams) بالـ pk -->
              {% if e.course.teams_link %}
                <a class="btn btn-primary"
                   href="{% url 'students:join_course_by_id' e.course.pk %}"
                   target="_blank" rel="noopener noreferrer">
                   دخول مباشر (Teams)
                </a>
              {% else %}
                <span class="muted">لا يوجد رابط تيمز متاح</span>
              {% endif %}
            </div>

            <div class="muted" style="margin-top:8px;">
              انضمام: {{ e.joined_at|date:"d-m-Y" }}
              {% if e.course.start_date or e.course.end_date %}
                — المدة: {{ e.course.start_date|date:"d-m-Y" }} إلى {{ e.course.end_date|date:"d-m-Y" }}
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <div class="empty">لا توجد دورات مسجّلة حتى الآن.</div>
      {% endif %}

      <!-- ===== الشهادات ===== -->
      <h3 class="section-title">شهاداتي</h3>
      {% if certs %}
        <ul class="list-cards">
          {% for c in certs %}
            <li class="list-card">
              <div>
                🎓 <b>{{ c.course }}</b>
                <small class="muted">— {{ c.issued_at|date:"d-m-Y" }}</small>
              </div>
              {% if c.file %}
                <a class="btn" href="{{ c.file.url }}" target="_blank" rel="noopener noreferrer">عرض الشهادة</a>
              {% elif c.file_url %}
                <a class="btn" href="{{ c.file_url }}" target="_blank" rel="noopener noreferrer">عرض الشهادة</a>
              {% elif c.link %}
                <a class="btn" href="{{ c.link }}" target="_blank" rel="noopener noreferrer">عرض الشهادة</a>
              {% else %}
                <span class="muted">لا يوجد ملف شهادة</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty">لا توجد شهادات حتى الآن.</div>
      {% endif %}

      <!-- ===== المراجع المتاحة ===== -->
      <h3 class="section-title">المراجع المتاحة</h3>
      {% if resources %}
        <ul class="list-cards">
          {% for r in resources %}
            <li class="list-card">
              <div>
                📄 <b>{{ r.title }}</b>
                <small class="muted">— {{ r.course|default:"عام" }}</small>
              </div>

              {% if r.file %}
                <a class="btn" href="{{ r.file.url }}" target="_blank" rel="noopener noreferrer">فتح المرجع</a>
              {% elif r.external_link %}
                <a class="btn" href="{{ r.external_link }}" target="_blank" rel="noopener noreferrer">فتح المرجع</a>
              {% elif r.link %}
                <a class="btn" href="{{ r.link }}" target="_blank" rel="noopener noreferrer">فتح المرجع</a>
              {% elif r.file_url %}
                <a class="btn" href="{{ r.file_url }}" target="_blank" rel="noopener noreferrer">فتح المرجع</a>
              {% else %}
                <span class="muted">لا يوجد رابط متاح</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty">لا توجد مراجع حتى الآن.</div>
      {% endif %}

    </section>
  </main>

  {% include "footer.html" %}
</body>
</html>
